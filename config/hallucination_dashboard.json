{
  "dashboard": {
    "title": "Hallucination Filtering System Monitoring",
    "description": "Comprehensive monitoring for the refactored hallucination filtering system",
    "refresh": "30s",
    "time": {
      "from": "now-1h",
      "to": "now"
    },
    "panels": [
      {
        "title": "Safety Overview",
        "type": "stat",
        "targets": [
          {
            "expr": "rate(hallucination_false_drops_total[5m]) / rate(hallucination_segments_processed_total[5m])",
            "legendFormat": "False Drop Rate",
            "refId": "A"
          },
          {
            "expr": "rate(hallucination_empty_after_trim_total[10m]) / rate(hallucination_segments_processed_total[10m])",
            "legendFormat": "Empty After Trim Rate",
            "refId": "B"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "percentunit",
            "thresholds": {
              "steps": [
                {"color": "green", "value": 0},
                {"color": "yellow", "value": 0.005},
                {"color": "red", "value": 0.01}
              ]
            }
          }
        }
      },
      {
        "title": "Trim Efficiency by Session Age",
        "type": "timeseries",
        "targets": [
          {
            "expr": "rate(hallucination_trim_efficiency_trimmed_total{session_age_bucket=\"0-5s\"}[5m]) / rate(hallucination_trim_efficiency_total{session_age_bucket=\"0-5s\"}[5m])",
            "legendFormat": "0-5s Bucket",
            "refId": "A"
          },
          {
            "expr": "rate(hallucination_trim_efficiency_trimmed_total{session_age_bucket=\"5-30s\"}[5m]) / rate(hallucination_trim_efficiency_total{session_age_bucket=\"5-30s\"}[5m])",
            "legendFormat": "5-30s Bucket",
            "refId": "B"
          },
          {
            "expr": "rate(hallucination_trim_efficiency_trimmed_total{session_age_bucket=\"30s+\"}[5m]) / rate(hallucination_trim_efficiency_total{session_age_bucket=\"30s+\"}[5m])",
            "legendFormat": "30s+ Bucket",
            "refId": "C"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "percentunit",
            "custom": {
              "thresholdsStyle": {
                "mode": "line"
              }
            },
            "thresholds": {
              "steps": [
                {"color": "transparent", "value": 0},
                {"color": "green", "value": 0.10},
                {"color": "yellow", "value": 0.30},
                {"color": "red", "value": 0.50}
              ]
            }
          }
        }
      },
      {
        "title": "Fallback Pressure",
        "type": "timeseries",
        "targets": [
          {
            "expr": "rate(hallucination_fallback_usage_total[10m]) / rate(hallucination_segments_processed_total[10m])",
            "legendFormat": "Fallback Rate {{fallback_reason}}",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "percentunit",
            "custom": {
              "thresholdsStyle": {
                "mode": "area"
              }
            },
            "thresholds": {
              "steps": [
                {"color": "green", "value": 0},
                {"color": "green", "value": 0.02},
                {"color": "yellow", "value": 0.05},
                {"color": "red", "value": 0.08}
              ]
            }
          }
        }
      },
      {
        "title": "First Utterance Duplicate Rate",
        "type": "stat",
        "targets": [
          {
            "expr": "rate(hallucination_first_utterance_duplicates_total[1h]) / rate(hallucination_first_utterance_sessions_total[1h])",
            "legendFormat": "Duplicate Rate",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "percentunit",
            "thresholds": {
              "steps": [
                {"color": "green", "value": 0},
                {"color": "yellow", "value": 0.025},
                {"color": "red", "value": 0.03}
              ]
            }
          }
        }
      },
      {
        "title": "Cut Word Count Distribution",
        "type": "heatmap",
        "targets": [
          {
            "expr": "rate(hallucination_cut_word_count_bucket[5m])",
            "legendFormat": "{{le}}",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "custom": {
              "hideFrom": {
                "legend": false,
                "tooltip": false,
                "vis": false
              },
              "scaleDistribution": {
                "type": "linear"
              }
            }
          }
        }
      },
      {
        "title": "Performance Metrics",
        "type": "timeseries",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(hallucination_post_asr_decision_duration_seconds_bucket[5m])) * 1000",
            "legendFormat": "Post-ASR Decision P95 (ms)",
            "refId": "A"
          },
          {
            "expr": "histogram_quantile(0.95, rate(hallucination_segment_processing_duration_seconds_bucket[5m])) * 1000",
            "legendFormat": "End-to-End P95 (ms)",
            "refId": "B"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "ms",
            "custom": {
              "thresholdsStyle": {
                "mode": "line"
              }
            },
            "thresholds": {
              "steps": [
                {"color": "green", "value": 0},
                {"color": "yellow", "value": 3},
                {"color": "red", "value": 5}
              ]
            }
          }
        }
      },
      {
        "title": "Context Health",
        "type": "timeseries",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(hallucination_context_tail_length_bucket[5m]))",
            "legendFormat": "Context Length P95",
            "refId": "A"
          },
          {
            "expr": "rate(hallucination_context_resets_total[10m])",
            "legendFormat": "Context Resets",
            "refId": "B"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "custom": {
              "axisLabel": "Tokens/Resets per sec"
            },
            "thresholds": {
              "steps": [
                {"color": "green", "value": 0},
                {"color": "yellow", "value": 150},
                {"color": "red", "value": 200}
              ]
            }
          }
        }
      },
      {
        "title": "Validator & PII Outcomes",
        "type": "timeseries",
        "targets": [
          {
            "expr": "rate(hallucination_validator_outcomes_total{outcome=\"fail\"}[10m]) / rate(hallucination_validator_outcomes_total[10m])",
            "legendFormat": "Validator Fail Rate",
            "refId": "A"
          },
          {
            "expr": "rate(hallucination_pii_outcomes_total{outcome=\"error\"}[10m]) / rate(hallucination_pii_outcomes_total[10m])",
            "legendFormat": "PII Error Rate",
            "refId": "B"
          },
          {
            "expr": "rate(hallucination_pii_outcomes_total{outcome=\"redact\"}[10m]) / rate(hallucination_pii_outcomes_total[10m])",
            "legendFormat": "PII Redaction Rate",
            "refId": "C"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "percentunit",
            "thresholds": {
              "steps": [
                {"color": "green", "value": 0},
                {"color": "yellow", "value": 0.002},
                {"color": "red", "value": 0.005}
              ]
            }
          }
        }
      }
    ]
  },
  "variables": [
    {
      "name": "provider",
      "type": "query",
      "query": "label_values(hallucination_segments_processed_total, provider)",
      "multi": true,
      "includeAll": true,
      "allValue": ".*"
    },
    {
      "name": "language",
      "type": "query",
      "query": "label_values(hallucination_segments_processed_total{provider=~\"$provider\"}, language)",
      "multi": true,
      "includeAll": true,
      "allValue": ".*"
    }
  ],
  "annotations": {
    "list": [
      {
        "name": "Deployments",
        "enable": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "query": "ALERTS{alertname=~\".*Deploy.*\"}"
      },
      {
        "name": "Hallucination Alerts",
        "enable": true,
        "iconColor": "rgba(255, 96, 96, 1)",
        "query": "ALERTS{alertname=~\"Hallucination.*\"}"
      }
    ]
  }
}