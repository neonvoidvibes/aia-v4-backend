# Security Fix: Prevent Unauthorized Agent Creation

## Date: 2025-01-29
## Priority: P1 - CRITICAL

## Problem Summary
Random agents were being automatically created in both Supabase and S3 with names like `e5d8bea81b8c49d7a9612e1dc97c09de` (32-character hex strings). These matched the pattern of wizard session IDs generated by `crypto.randomUUID()`.

## Root Cause Analysis

### Attack Vector
The wizard chat interface creates session IDs like `wizard-session-{uuid}` for each agent creation session. Through a series of interactions:

1. **Wizard Session Creation** (create-agent-wizard.tsx:86)
   - Generates: `wizard-session-e5d8bea81b8c49d7a9612e1dc97c09de`
   - Uses `_aicreator` agent for AI assistance

2. **Chat History Auto-Save** (api_server.py:5461)
   - Wizard sessions attempt to save chat history
   - No validation against wizard session IDs
   - Could trigger agent lookups/creation

3. **Agent Sync from S3** (api_server.py:5023)
   - Automatically syncs S3 folders to Supabase
   - No validation of agent name patterns
   - Would create DB entries for invalid S3 folders

## Implemented Fixes (Priority 1)

### Fix 1: Agent Creation Endpoint Validation
**Location:** `api_server.py:4146-4155`

Added three layers of validation:
1. ✅ **Format validation**: Must start with lowercase letter, contain only `[a-z0-9-]`
2. ✅ **Pattern blocking**: Reject `wizard-session-*` prefixes
3. ✅ **UUID blocking**: Reject 32-character hex strings (UUID pattern)

```python
# SECURITY: Validate agent name format
if not re.match(r'^[a-z][a-z0-9-]*$', agent_name):
    logger.warning(f"BLOCKED: Invalid agent name format attempted: '{agent_name}' by user {user.id}")
    return jsonify({"error": "Invalid agent name format..."}), 400

if agent_name.startswith('wizard-session') or re.match(r'^[0-9a-f]{32}$', agent_name):
    logger.warning(f"BLOCKED: Suspicious agent name attempted: '{agent_name}' by user {user.id}")
    return jsonify({"error": "Invalid agent name..."}), 400
```

### Fix 2: Chat History Save Protection
**Location:** `api_server.py:5473-5484`

Blocks wizard sessions from saving chat history:

```python
# SECURITY: Block wizard sessions from creating chat history/agent entries
if client_session_id and client_session_id.startswith('wizard-session'):
    logger.info(f"BLOCKED: Wizard session {client_session_id} attempted to save...")
    return jsonify({'success': True, 'chatId': None, 'message': 'Wizard sessions are not saved'}), 200

# Additional validation: prevent UUID-like or wizard-session agent names
if agent_name.startswith('wizard-session') or re.match(r'^[0-9a-f]{32}$', agent_name):
    logger.warning(f"BLOCKED: Suspicious agent name in chat save...")
    return jsonify({'success': True, 'chatId': None, 'message': 'Invalid agent name pattern'}), 200
```

### Fix 3: S3-to-Supabase Sync Validation
**Location:** `api_server.py:5051-5068`

Filters invalid agent names during automatic sync:

```python
# SECURITY: Filter out invalid agent names (wizard sessions, UUIDs, etc.)
def is_valid_agent_name(name):
    return (re.match(r'^[a-z][a-z0-9-]*$', name) and
            not name.startswith('wizard-session') and
            not re.match(r'^[0-9a-f]{32}$', name))

valid_missing_agents = [name for name in missing_agents if is_valid_agent_name(name)]
invalid_agents = [name for name in missing_agents if not is_valid_agent_name(name)]

if invalid_agents:
    logger.warning(f"Agent Sync: BLOCKED {len(invalid_agents)} invalid agent names from sync: {invalid_agents}")
```

### Fix 4: Enhanced Logging (Step 6)
All three fixes include detailed logging:
- ✅ Logs blocked attempts with user IDs
- ✅ Logs suspicious patterns detected
- ✅ Logs successful agent creation requests
- ✅ Allows forensic analysis of past attempts

## Testing

### Syntax Validation
```bash
✓ python -m py_compile api_server.py
```

### Test Cases to Verify

1. **Legitimate agent creation** should work:
   ```
   ✓ agent_name: "customer-support"
   ✓ agent_name: "test-bot-2"
   ```

2. **Invalid patterns** should be blocked:
   ```
   ✗ agent_name: "wizard-session-abc123"
   ✗ agent_name: "e5d8bea81b8c49d7a9612e1dc97c09de"
   ✗ agent_name: "Agent123" (uppercase)
   ✗ agent_name: "123agent" (starts with number)
   ```

3. **Wizard chat sessions** should not save history:
   ```
   ✗ client_session_id: "wizard-session-{uuid}"
   ```

## Next Steps (Priority 2 & 3)

### Priority 2: Cleanup
Run these SQL commands to remove rogue agents:

```sql
-- Find suspicious agents
SELECT id, name, created_at
FROM agents
WHERE name ~ '^[0-9a-f]{32}$'
   OR name LIKE 'wizard-session%'
ORDER BY created_at DESC;

-- After verification, delete them:
DELETE FROM agents
WHERE name ~ '^[0-9a-f]{32}$'
   OR name LIKE 'wizard-session%';
```

Clean S3 folders:
```bash
# List suspicious S3 folders
aws s3 ls s3://your-bucket/organizations/river/agents/ | grep -E '^[0-9a-f]{32}$|wizard-session'

# Delete after verification
aws s3 rm s3://your-bucket/organizations/river/agents/{agent_name}/ --recursive
```

### Priority 3: Database Constraint
Add permanent database constraint:

```sql
ALTER TABLE agents
ADD CONSTRAINT agents_name_format
CHECK (
    name ~ '^[a-z][a-z0-9-]*$'
    AND NOT (name LIKE 'wizard-session%')
    AND NOT (name ~ '^[0-9a-f]{32}$')
);
```

## Monitoring

Watch logs for these patterns:
```bash
# Look for blocked attempts
grep "BLOCKED:" api_server.log

# Monitor agent creation requests
grep "Agent creation request received:" api_server.log

# Check for suspicious patterns
grep -E "wizard-session|[0-9a-f]{32}" api_server.log
```

## Impact Assessment

### Before Fix
- ⚠️ Random agents created automatically
- ⚠️ Database pollution with invalid entries
- ⚠️ S3 storage waste with orphaned folders
- ⚠️ No audit trail of creation source

### After Fix
- ✅ All agent creation requests validated
- ✅ Wizard sessions isolated from production data
- ✅ Invalid patterns blocked at multiple layers
- ✅ Comprehensive logging for security audits
- ✅ Automatic sync protected from bad data

## Related Files Modified
- `api_server.py` (3 functions modified)
  - `create_agent()` - Line 4146-4155
  - `save_chat_history()` - Line 5473-5484
  - `sync_agents_from_s3_to_supabase()` - Line 5051-5068

## Rollback Plan
If issues occur, the changes are isolated to three functions. Simply revert the validation blocks while keeping the logging statements to diagnose the issue.